<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suivi des Compétences Transversales</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Configuration de l'API
    const API_URL = window.location.origin;

    const App = () => {
      const [userType, setUserType] = useState('eleve');
      const [currentUser, setCurrentUser] = useState('');
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [selectedWeek, setSelectedWeek] = useState('');
      const [evaluations, setEvaluations] = useState([]);
      const [showHistory, setShowHistory] = useState(false);
      const [loading, setLoading] = useState(false);
      
      const eleves = [
        { id: 1, nom: 'AND', prenom: 'Melaniia' },
        { id: 2, nom: 'BEN', prenom: 'Benali' },
        { id: 3, nom: 'CHA', prenom: 'Amine' },
        { id: 4, nom: 'CRE', prenom: 'Thibaud' },
        { id: 5, nom: 'DOM', prenom: 'Delvano' },
        { id: 6, nom: 'DUV', prenom: 'Nhoa' },
        { id: 7, nom: 'ELF', prenom: 'Nizar' },
        { id: 8, nom: 'GAR', prenom: 'Kalvin' },
        { id: 9, nom: 'LAH', prenom: 'Samuel' },
        { id: 10, nom: 'MIG', prenom: 'Simon' },
        { id: 11, nom: 'MIR', prenom: 'Anaïs' },
        { id: 12, nom: 'RAF', prenom: 'Mathéo' },
        { id: 13, nom: 'RAM', prenom: 'Soukaïna' },
        { id: 14, nom: 'YOB', prenom: 'Shaylis' }
      ];

      const engagementPaliers = [
        { niveau: 1, label: 'Très insuffisant' },
        { niveau: 2, label: 'Insuffisant' },
        { niveau: 3, label: 'Satisfaisant' },
        { niveau: 4, label: 'Bien' },
        { niveau: 5, label: 'Très bien' }
      ];

      const comportementPaliers = [
        { niveau: 1, label: 'Insuffisant' },
        { niveau: 2, label: 'Satisfaisant' },
        { niveau: 3, label: 'Bien' },
        { niveau: 4, label: 'Très bien' }
      ];

      useEffect(() => {
        loadEvaluations();
        const today = new Date();
        setSelectedWeek(getWeekNumber(today));
      }, []);

      const loadEvaluations = async () => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/evaluations`);
          const data = await response.json();
          setEvaluations(data);
        } catch (error) {
          console.error('Erreur chargement:', error);
          alert('Erreur de connexion au serveur');
        }
        setLoading(false);
      };

      const getWeekNumber = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `${d.getFullYear()}-S${weekNo}`;
      };

      const saveEvaluation = async (data) => {
        try {
          const response = await fetch(`${API_URL}/api/evaluations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) throw new Error('Erreur serveur');
          
          await loadEvaluations();
          return true;
        } catch (error) {
          console.error('Erreur sauvegarde:', error);
          alert('Erreur lors de la sauvegarde');
          return false;
        }
      };

      const handleAutoEvaluation = async (engagement, isAbsent = false) => {
        if (!isLoggedIn || !currentUser) {
          alert('Erreur de connexion');
          return;
        }

        const eleve = eleves.find(e => e.id === parseInt(currentUser));
        const existingAutoEval = evaluations.find(
          e => e.semaine === selectedWeek && 
               e.eleveId === eleve.id && 
               e.type === 'auto'
        );

        if (existingAutoEval && !isAbsent) {
          alert('Vous avez déjà saisi votre auto-évaluation pour cette semaine.');
          return;
        }

        const eval_data = {
          semaine: selectedWeek,
          eleveId: eleve.id,
          eleveNom: `${eleve.prenom} ${eleve.nom}`,
          type: 'auto',
          engagement: isAbsent ? 'absent' : engagement,
          comportement: null,
          absent: isAbsent ? 1 : 0,
          date: new Date().toISOString()
        };

        const success = await saveEvaluation(eval_data);
        if (success) {
          alert(isAbsent ? 'Absence enregistrée !' : 'Auto-évaluation enregistrée !');
        }
      };

      const handleLogin = () => {
        if (!currentUser) {
          alert('Veuillez sélectionner votre nom');
          return;
        }
        setIsLoggedIn(true);
      };

      const handleLogout = () => {
        setIsLoggedIn(false);
        setCurrentUser('');
      };

      const handleUserTypeChange = (type) => {
        setUserType(type);
        setIsLoggedIn(false);
        setCurrentUser('');
      };

      const hasAutoEvalForWeek = (eleveId, semaine) => {
        return evaluations.some(
          e => e.semaine === semaine && 
               e.eleveId === eleveId && 
               e.type === 'auto'
        );
      };

      const getPastWeeks = (numberOfWeeks = 8) => {
        const weeks = [];
        const today = new Date();
        for (let i = 0; i < numberOfWeeks; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - (i * 7));
          weeks.push(getWeekNumber(date));
        }
        return weeks;
      };

      const getEleveEvaluations = (eleveId) => {
        return evaluations
          .filter(e => e.eleveId === eleveId)
          .sort((a, b) => b.semaine.localeCompare(a.semaine));
      };

      const exportTrimestre = (trimestre) => {
        const weeks = getWeeksForTrimestre(trimestre);
        const data = evaluations.filter(e => weeks.includes(e.semaine));
        
        let csv = 'Élève,Semaine,Type,Engagement,Comportement,Absent\n';
        data.forEach(e => {
          csv += `${e.eleveNom},${e.semaine},${e.type},${e.engagement || 'N/A'},${e.comportement || 'N/A'},${e.absent ? 'Oui' : 'Non'}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `evaluations_trimestre_${trimestre}.csv`;
        a.click();
      };

      const getWeeksForTrimestre = (trimestre) => {
        const year = new Date().getFullYear();
        if (trimestre === 1) return Array.from({length: 13}, (_, i) => `${year}-S${i + 36}`);
        if (trimestre === 2) return Array.from({length: 13}, (_, i) => `${year + 1}-S${i + 1}`);
        return Array.from({length: 13}, (_, i) => `${year + 1}-S${i + 14}`);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-indigo-900 mb-2">
                Suivi des Compétences Transversales
              </h1>
              <p className="text-gray-600">Évaluation hebdomadaire - Chef d'œuvre</p>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <div className="flex gap-4 mb-4">
                <button
                  onClick={() => handleUserTypeChange('eleve')}
                  className={`flex-1 py-3 px-4 rounded-lg font-semibold transition ${
                    userType === 'eleve'
                      ? 'bg-indigo-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  Mode Élève
                </button>
                <button
                  onClick={() => handleUserTypeChange('enseignant')}
                  className={`flex-1 py-3 px-4 rounded-lg font-semibold transition ${
                    userType === 'enseignant'
                      ? 'bg-indigo-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  Mode Enseignant
                </button>
              </div>

              {userType === 'eleve' && isLoggedIn ? (
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Semaine à évaluer
                  </label>
                  <select
                    value={selectedWeek}
                    onChange={(e) => setSelectedWeek(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  >
                    {getPastWeeks().map(week => {
                      const hasEval = hasAutoEvalForWeek(parseInt(currentUser), week);
                      return (
                        <option key={week} value={week}>
                          {week} {hasEval ? '✓ (déjà remplie)' : ''}
                        </option>
                      );
                    })}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">
                    Vous pouvez saisir les semaines passées si vous avez oublié
                  </p>
                </div>
              ) : (
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Semaine
                  </label>
                  <input
                    type="text"
                    value={selectedWeek}
                    onChange={(e) => setSelectedWeek(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-lg"
                    placeholder="Ex: 2024-S45"
                  />
                </div>
              )}
            </div>

            {userType === 'eleve' ? (
              !isLoggedIn ? (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Connexion Élève</h2>
                  
                  <div className="mb-6">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Sélectionnez votre nom :
                    </label>
                    <select
                      value={currentUser}
                      onChange={(e) => setCurrentUser(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    >
                      <option value="">Choisir...</option>
                      {eleves.map(e => (
                        <option key={e.id} value={e.id}>
                          {e.prenom} {e.nom}
                        </option>
                      ))}
                    </select>
                  </div>

                  <button
                    onClick={handleLogin}
                    className="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
                  >
                    Se connecter
                  </button>
                </div>
              ) : (
                <EleveView
                  eleves={eleves}
                  currentUser={currentUser}
                  selectedWeek={selectedWeek}
                  engagementPaliers={engagementPaliers}
                  handleAutoEvaluation={handleAutoEvaluation}
                  handleLogout={handleLogout}
                  hasAutoEvalForWeek={hasAutoEvalForWeek}
                  getEleveEvaluations={getEleveEvaluations}
                  evaluations={evaluations}
                />
              )
            ) : (
              <EnseignantView
                eleves={eleves}
                selectedWeek={selectedWeek}
                engagementPaliers={engagementPaliers}
                comportementPaliers={comportementPaliers}
                saveEvaluation={saveEvaluation}
                loadEvaluations={loadEvaluations}
              />
            )}

            <HistoryExport
              evaluations={evaluations}
              showHistory={showHistory}
              setShowHistory={setShowHistory}
              exportTrimestre={exportTrimestre}
            />
          </div>
        </div>
      );
    };

    const EleveView = ({ eleves, currentUser, selectedWeek, engagementPaliers, handleAutoEvaluation, handleLogout, hasAutoEvalForWeek, getEleveEvaluations }) => {
      const eleve = eleves.find(e => e.id === parseInt(currentUser));
      const hasEval = hasAutoEvalForWeek(parseInt(currentUser), selectedWeek);

      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">
              Auto-évaluation - {eleve?.prenom} {eleve?.nom}
            </h2>
            <button
              onClick={handleLogout}
              className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
            >
              Se déconnecter
            </button>
          </div>

          {hasEval ? (
            <div className="mb-6 p-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg">
              <p className="text-yellow-800 font-semibold">
                ⚠️ Vous avez déjà rempli votre auto-évaluation pour la semaine {selectedWeek}.
              </p>
              <p className="text-sm text-yellow-700 mt-2">
                Sélectionnez une autre semaine si vous avez oublié de remplir une semaine passée.
              </p>
            </div>
          ) : (
            <>
              <div className="mb-6">
                <h3 className="font-semibold text-gray-800 mb-3">
                  Engagement dans le chef d'œuvre - Semaine {selectedWeek}
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                  {engagementPaliers.map(p => (
                    <button
                      key={p.niveau}
                      onClick={() => handleAutoEvaluation(p.niveau, false)}
                      className="p-4 border-2 border-indigo-300 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition"
                    >
                      <div className="text-2xl font-bold text-indigo-600 mb-1">{p.niveau}</div>
                      <div className="text-sm text-gray-700">{p.label}</div>
                    </button>
                  ))}
                </div>
              </div>

              <div className="mb-6">
                <button
                  onClick={() => handleAutoEvaluation(null, true)}
                  className="w-full p-4 border-2 border-orange-400 bg-orange-50 rounded-lg hover:bg-orange-100 transition"
                >
                  <div className="text-lg font-bold text-orange-700">
                    ✋ J'étais absent(e) cette semaine
                  </div>
                </button>
              </div>
            </>
          )}

          <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 className="font-semibold text-blue-900 mb-2">Mes évaluations récentes</h3>
            <div className="space-y-2">
              {getEleveEvaluations(parseInt(currentUser)).slice(0, 5).map((e, i) => (
                <div key={i} className="text-sm bg-white p-2 rounded">
                  <span className="font-semibold">{e.semaine}</span> - 
                  {e.absent ? (
                    <span className="ml-2 text-orange-600 font-semibold">Absent(e)</span>
                  ) : (
                    <span className="ml-2">Engagement: <span className="font-bold text-indigo-600">{e.engagement}/5</span></span>
                  )}
                  {e.type === 'prof' && e.comportement && (
                    <span className="ml-2">- Comportement: <span className="font-bold text-purple-600">{e.comportement}/4</span></span>
                  )}
                  <span className="ml-2 text-xs text-gray-500">({e.type === 'auto' ? 'Auto' : 'Prof'})</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const EnseignantView = ({ eleves, selectedWeek, engagementPaliers, comportementPaliers, saveEvaluation, loadEvaluations }) => {
      const [selectedEleve, setSelectedEleve] = useState(null);
      const [engagement, setEngagement] = useState(null);
      const [comportement, setComportement] = useState(null);

      const handleSubmit = async () => {
        if (!selectedEleve || !engagement || !comportement) {
          alert('Veuillez remplir tous les champs');
          return;
        }

        const eleve = eleves.find(e => e.id === selectedEleve);
        const eval_data = {
          semaine: selectedWeek,
          eleveId: eleve.id,
          eleveNom: `${eleve.prenom} ${eleve.nom}`,
          type: 'prof',
          engagement,
          comportement,
          absent: 0,
          date: new Date().toISOString()
        };

        const success = await saveEvaluation(eval_data);
        if (success) {
          alert('Évaluation enregistrée !');
          setSelectedEleve(null);
          setEngagement(null);
          setComportement(null);
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Évaluation Enseignant</h2>

          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Élève à évaluer
            </label>
            <select
              value={selectedEleve || ''}
              onChange={(e) => setSelectedEleve(parseInt(e.target.value))}
              className="w-full p-3 border border-gray-300 rounded-lg"
            >
              <option value="">Sélectionner un élève</option>
              {eleves.map(e => (
                <option key={e.id} value={e.id}>
                  {e.prenom} {e.nom}
                </option>
              ))}
            </select>
          </div>

          <div className="mb-6">
            <h3 className="font-semibold text-gray-800 mb-3">
              Engagement dans le chef d'œuvre
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
              {engagementPaliers.map(p => (
                <button
                  key={p.niveau}
                  onClick={() => setEngagement(p.niveau)}
                  className={`p-4 border-2 rounded-lg transition ${
                    engagement === p.niveau
                      ? 'border-indigo-600 bg-indigo-50'
                      : 'border-gray-300 hover:border-indigo-400'
                  }`}
                >
                  <div className="text-2xl font-bold text-indigo-600 mb-1">{p.niveau}</div>
                  <div className="text-sm text-gray-700">{p.label}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="mb-6">
            <h3 className="font-semibold text-gray-800 mb-3">
              Comportement
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {comportementPaliers.map(p => (
                <button
                  key={p.niveau}
                  onClick={() => setComportement(p.niveau)}
                  className={`p-4 border-2 rounded-lg transition ${
                    comportement === p.niveau
                      ? 'border-purple-600 bg-purple-50'
                      : 'border-gray-300 hover:border-purple-400'
                  }`}
                >
                  <div className="text-2xl font-bold text-purple-600 mb-1">{p.niveau}</div>
                  <div className="text-sm text-gray-700">{p.label}</div>
                </button>
              ))}
            </div>
          </div>

          <button
            onClick={handleSubmit}
            className="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
          >
            Enregistrer l'évaluation
          </button>
        </div>
      );
    };

    const HistoryExport = ({ evaluations, showHistory, setShowHistory, exportTrimestre }) => {
      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">Historique & Export</h2>
            <button
              onClick={() => setShowHistory(!showHistory)}
              className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
            >
              {showHistory ? 'Masquer' : 'Afficher'} l'historique
            </button>
          </div>

          <div className="flex gap-3 mb-4">
            <button
              onClick={() => exportTrimestre(1)}
              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Export Trimestre 1
            </button>
            <button
              onClick={() => exportTrimestre(2)}
              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Export Trimestre 2
            </button>
            <button
              onClick={() => exportTrimestre(3)}
              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Export Trimestre 3
            </button>
          </div>

          {showHistory && (
            <div className="mt-6">
              <h3 className="font-semibold text-gray-800 mb-3">Dernières évaluations</h3>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {evaluations
                  .sort((a, b) => b.semaine.localeCompare(a.semaine))
                  .slice(0, 20)
                  .map((e, i) => (
                    <div key={i} className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <div className="flex justify-between items-start">
                        <div>
                          <span className="font-semibold text-gray-800">{e.eleveNom}</span>
                          <span className="mx-2 text-gray-400">•</span>
                          <span className="text-gray-600">{e.semaine}</span>
                          <span className="mx-2 text-gray-400">•</span>
                          <span className={`text-sm font-semibold ${e.type === 'auto' ? 'text-blue-600' : 'text-purple-600'}`}>
                            {e.type === 'auto' ? 'Auto' : 'Prof'}
                          </span>
                        </div>
                        <div className="text-right text-sm">
                          {e.absent ? (
                            <div className="font-bold text-orange-600">Absent(e)</div>
                          ) : (
                            <div>Engagement: <span className="font-bold text-indigo-600">{e.engagement}/5</span></div>
                          )}
                          {e.comportement && (
                            <div>Comportement: <span className="font-bold text-purple-600">{e.comportement}/4</span></div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>